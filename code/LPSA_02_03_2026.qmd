---
title: "LPSA_02_03_2026"
format: html
---

```{r lpsa-parsers, warning=FALSE, message=FALSE}

library(readr)
library(dplyr)
library(stringr)
library(purrr)
library(tibble)

test <- read.csv("../data/LPSA/LPSA_data/November 6th, 2025/PerryProfi_250246A_ 6 Nov 2025_10-04_60.$av..csv.__OLDSTYLE__.csv")
test
```

```{r}

root <- "../data/LPSA/LPSA_data"

read_lpsa_raw <- function(path) {
  lines <- readr::read_lines(path, progress = FALSE)
  lines <- lines[nzchar(trimws(lines))]
  lines
}

sanitize_sample_id <- function(x) {
  if (is.na(x)) return(NA_character_)
  x <- str_trim(x)
  # pull an ID of the form 6 digits + 1 letter (e.g., 230061B, 250246A)
  id <- str_extract(x, "\\b\\d{6}[A-Za-z]\\b")
  if (is.na(id)) return(NA_character_)
  toupper(id)
}

extract_sample_id_from_header <- function(path) {
  hdr <- tryCatch(
    readr::read_csv(path, n_max = 0, show_col_types = FALSE),
    error = function(e) NULL
  )
  if (is.null(hdr)) return(NA_character_)
  nms <- names(hdr)
  if (length(nms) < 2) return(NA_character_)
  sanitize_sample_id(nms[2])
}

extract_lpsa_metrics <- function(path, lines) {
  sample_id <- extract_sample_id_from_header(path)

  current_block <- NA_character_
  clay <- NA_real_
  sand <- NA_real_

  for (ln in lines) {
    if (str_detect(ln, "%\\s*<")) current_block <- "lt"
    if (str_detect(ln, "%\\s*>")) current_block <- "gt"

    nums <- str_extract_all(ln, "\\d+(?:\\.\\d+)?")[[1]]
    if (length(nums) < 2) next

    size <- suppressWarnings(as.numeric(nums[1]))
    val  <- suppressWarnings(as.numeric(nums[2]))

    if (!is.na(size) && size == 2  && identical(current_block, "lt")) clay <- val
    if (!is.na(size) && size == 50 && identical(current_block, "gt")) sand <- val
  }

  tibble(sample_id = sample_id, clay_pct = clay, sand_pct = sand)
}

get_sampling_date_from_path <- function(path) basename(dirname(path))

all_files <- list.files(root, pattern = "\\.csv$", recursive = TRUE, full.names = TRUE)

out <- map_dfr(all_files, function(f) {
  lines <- read_lpsa_raw(f)

  has_lt <- any(str_detect(lines, "%\\s*<"))
  has_gt <- any(str_detect(lines, "%\\s*>"))
  if (!(has_lt && has_gt)) return(NULL)

  metrics <- extract_lpsa_metrics(f, lines)

  metrics %>%
    mutate(
      date_sampled = get_sampling_date_from_path(f),
      file = f
    )
})

final <- out %>%
  filter(!is.na(sample_id)) %>%          # drop the timestamp-like ones
  select(sample_id, clay_pct, sand_pct, date_sampled) %>%
  distinct()

final
write_csv(final, "../output_do_not_push/lpsa_all_results_02_04_2026.csv")

```


